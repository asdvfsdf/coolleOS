## 2023.9.22

### sv39
``````
// Sv39 linear address structure
// +-------9--------+-------9--------+--------9---------+----------12----------+
// |      VPN2      |      VPN1      |       VPN0       |  Offset within Page  |
// +----------------+----------------+------------------+----------------------+

// Sv39 in RISC-V64 uses 39-bit virtual address to access 56-bit physical address!
// Sv39 page table entry(PTE):
// +-------10--------+--------26-------+--------9----------+--------9--------+---2----+-------8-------+
// |    Reserved     |      PPN[2]     |      PPN[1]       |      PPN[0]     |Reserved|D|A|G|U|X|W|R|V|
// +-----------------+-----------------+-------------------+-----------------+--------+---------------+

默认位为1的效果  
2位reserved留给S mode的应用程序，可以用来进行拓展  
D表示自从上次被清0之后，有虚拟地址通过这个页表项进行写入
A表示自从上次被清零后有虚拟地址通过这个页表项进行读写或取指
G表示这个页表项是全局的，也就是所有的地址空间都包含这一项
U表示用户态可以通过这个页表项进行映射
注意，S Mode 不一定可以通过U=1的页表项进行映射。我们需要将 S Mode 的状态寄存器 sstatus 上的 SUM 位手动设置为 1 才可以做到这一点（通常情况不会把它置1）。否则通过 U=1 的页表项进行映射也会报出异常。另外，不论sstatus的SUM位如何取值，S Mode都不允许执行  U=1的页面里包含的指令，这是出于安全的考虑。
R,W,X为许可位，分别表示是否可读 (Readable)，可写 (Writable)，可执行 (Executable)。
V表示这个页表项是否合法。如果为 00 表示不合法，此时页表项其他位的值都会被忽略。

``````


在 Sv39 中，定义物理地址(Physical Address)有 56位，而虚拟地址(Virtual Address) 有 39位。实际使用的时候，一个虚拟地址要占用 64位，只有低 39位有效，规定 63−39 位的值必须等于第 38 位的值（类似有符号整数），否则会认为该虚拟地址不合法，在访问时会产生异常。  

不论是物理地址还是虚拟地址，我们都可以认为，最后12位表示的是页内偏移。除了最后12位，前面的部分表示的是物理页号或者虚拟页号。   

Sv39 里面的一个页表项大小为64位8字节。其中第53-10共44位为一个物理页号，表示这个虚拟页号映射到的物理页号。后面的第9-0位则描述映射的状态信息。  



### 内核初始映射过程
1. 设置好satp寄存器的值，satp寄存器值由模式值和页表基址物理页号组成，页表基址物理页号由三级页表的虚拟地址（这个哪来的？）减去虚实映射偏移量得到  
2. 要在汇编代码中，为那啥三级页表虚拟地址预留好空间（4k） 
3. 执行sfance.vma  
4. 将sp设置为虚拟地址  
5. 跳转到内核  